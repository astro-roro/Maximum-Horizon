<UserControl x:Class="NINA.Plugin.MaximumHorizon.Views.MaximumHorizonOptionsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Profile Management Section -->
        <GroupBox Grid.Row="0" Header="Horizon Profiles" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <ComboBox Grid.Column="0" 
                          ItemsSource="{Binding AvailableProfiles}"
                          SelectedItem="{Binding SelectedProfile}"
                          Margin="0,0,5,0"
                          VerticalContentAlignment="Center"/>

                <Button Grid.Column="1" 
                        Content="New Profile" 
                        Command="{Binding CreateNewProfileCommand}"
                        Margin="5,0,5,0"
                        Padding="10,5"/>

                <Button Grid.Column="2" 
                        Content="Duplicate" 
                        Command="{Binding DuplicateProfileCommand}"
                        CommandParameter="{Binding SelectedProfile}"
                        Margin="5,0,5,0"
                        Padding="10,5"/>

                <Button Grid.Column="3" 
                        Content="Delete" 
                        Command="{Binding DeleteProfileCommand}"
                        CommandParameter="{Binding SelectedProfile}"
                        Margin="5,0,5,0"
                        Padding="10,5"/>

                <TextBox Grid.Column="4" 
                         Text="{Binding NewProfileName}"
                         Margin="5,0,0,0"
                         Padding="5"
                         MinWidth="150"
                         VerticalContentAlignment="Center"/>
            </Grid>
        </GroupBox>

        <!-- Global Settings -->
        <GroupBox Grid.Row="1" Header="Maximum Horizon Settings" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" Text="Margin (degrees):" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                    <Slider Minimum="0" Maximum="10" TickFrequency="1" IsSnapToTickEnabled="True"
                            Value="{Binding MarginBuffer, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            Width="200" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding MarginBuffer, StringFormat='{}{0:F1}°'}"
                               Margin="8,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- Horizon Visualization -->
        <GroupBox Grid.Row="2" Header="Horizon Profile Visualization" Margin="0,0,0,10">
            <Canvas x:Name="HorizonCanvas" Background="LightGray" ClipToBounds="True" Height="300">
                <!-- This will be drawn in code-behind -->
            </Canvas>
        </GroupBox>

        <!-- Tab Control for different input methods -->
        <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto">
            <TabControl>
                <!-- Manual Entry Tab -->
                <TabItem Header="Manual Entry">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Add azimuth points manually. Click + to add a row." 
                                       VerticalAlignment="Center"
                                       Margin="0,0,10,0"/>
                            <Button Content="+" 
                                    Command="{Binding AddRowCommand}"
                                    Width="30" Height="30"
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Padding="0"/>
                        </StackPanel>

                        <DataGrid x:Name="PointsGridManual"
                                  Grid.Row="1" 
                                  ItemsSource="{Binding HorizonPoints}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  GridLinesVisibility="All"
                                  Margin="0,0,0,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Azimuth (degrees)" 
                                                    Binding="{Binding Azimuth}" 
                                                    Width="150"/>
                                <DataGridTextColumn Header="Max Altitude (degrees)" 
                                                    Binding="{Binding MaxAltitude}" 
                                                    Width="*"/>
                                <DataGridTemplateColumn Header="" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="✕" 
                                                    Command="{Binding DataContext.DeleteRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Width="25" Height="25"
                                                    Padding="0"
                                                    FontSize="12"
                                                    FontWeight="Bold"
                                                    Foreground="Red"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Cursor="Hand"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="2" 
                                Content="Save Profile" 
                                Click="OnSaveProfileClick"
                                HorizontalAlignment="Right"
                                Margin="0,10,0,0"
                                Padding="20,5"/>
                    </Grid>
                </TabItem>

                <!-- CSV Import Tab -->
                <TabItem Header="CSV Import">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" 
                                   Text="Import horizon profile from CSV file. Expected format: Azimuth,MaxAltitude"
                                   Margin="0,0,0,10"/>

                        <Grid Grid.Row="1" Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBox Grid.Column="0" 
                                     Text="{Binding CsvFilePath}"
                                     IsReadOnly="True"
                                     Margin="0,0,10,0"
                                     Padding="5"
                                     VerticalContentAlignment="Center"/>

                            <Button Grid.Column="1" 
                                    Content="Browse..." 
                                    Command="{Binding ImportCsvCommand}"
                                    Padding="15,5"/>
                        </Grid>

                        <DataGrid x:Name="PointsGridCsv"
                                  Grid.Row="2" 
                                  ItemsSource="{Binding HorizonPoints}"
                                  AutoGenerateColumns="False"
                                  GridLinesVisibility="All">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Azimuth (degrees)" 
                                                    Binding="{Binding Azimuth}" 
                                                    Width="150"/>
                                <DataGridTextColumn Header="Max Altitude (degrees)" 
                                                    Binding="{Binding MaxAltitude}" 
                                                    Width="*"/>
                                <DataGridTemplateColumn Header="" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="✕" 
                                                    Command="{Binding DataContext.DeleteRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Width="25" Height="25"
                                                    Padding="0"
                                                    FontSize="12"
                                                    FontWeight="Bold"
                                                    Foreground="Red"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Cursor="Hand"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="3" 
                                Content="Save Profile" 
                                Click="OnSaveProfileClick"
                                HorizontalAlignment="Right"
                                Margin="0,10,0,0"
                                Padding="20,5"/>
                    </Grid>
                </TabItem>

                <!-- Image Import Tab -->
                <TabItem Header="Image Import">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" 
                                   Text="Import horizon profile from image. White pixels = visible sky, Black pixels = obstructions. Recommended: 360 pixels wide (1 pixel per degree)."
                                   TextWrapping="Wrap"
                                   Margin="0,0,0,10"/>

                        <Grid Grid.Row="1" Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBox Grid.Column="0" 
                                     Text="{Binding ImageFilePath}"
                                     IsReadOnly="True"
                                     Margin="0,0,10,0"
                                     Padding="5"
                                     VerticalContentAlignment="Center"/>

                            <Button Grid.Column="1" 
                                    Content="Browse..." 
                                    Command="{Binding ImportImageCommand}"
                                    Padding="15,5"/>
                        </Grid>

                        <Grid Grid.Row="2" Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Label Grid.Column="0" 
                                   Content="Threshold:" 
                                   VerticalAlignment="Center"
                                   Margin="0,0,10,0"/>

                            <Slider Grid.Column="1" 
                                    Minimum="0" 
                                    Maximum="255" 
                                    Value="{Binding ImageThreshold}"
                                    VerticalAlignment="Center"
                                    Margin="0,0,10,0"/>

                            <TextBlock Grid.Column="2" 
                                       Text="{Binding ImageThreshold}"
                                       VerticalAlignment="Center"
                                       MinWidth="30"/>
                        </Grid>

                        <DataGrid x:Name="PointsGridImage"
                                  Grid.Row="3" 
                                  ItemsSource="{Binding HorizonPoints}"
                                  AutoGenerateColumns="False"
                                  GridLinesVisibility="All">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Azimuth (degrees)" 
                                                    Binding="{Binding Azimuth}" 
                                                    Width="150"/>
                                <DataGridTextColumn Header="Max Altitude (degrees)" 
                                                    Binding="{Binding MaxAltitude}" 
                                                    Width="*"/>
                                <DataGridTemplateColumn Header="" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="✕" 
                                                    Command="{Binding DataContext.DeleteRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Width="25" Height="25"
                                                    Padding="0"
                                                    FontSize="12"
                                                    FontWeight="Bold"
                                                    Foreground="Red"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Cursor="Hand"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="4" 
                                Content="Save Profile" 
                                Click="OnSaveProfileClick"
                                HorizontalAlignment="Right"
                                Margin="0,10,0,0"
                                Padding="20,5"/>
                    </Grid>
                </TabItem>
            </TabControl>
        </ScrollViewer>
    </Grid>
</UserControl>

